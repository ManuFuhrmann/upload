kind: pipeline
name: CI/CD

steps:
- name: composer-install
  image: composer
  commands:
  - composer install

- name: phpunit-test
  image: php:8
  commands:
  - vendor/bin/phpunit --configuration phpunit.xml
  depends_on:
  - composer-install

- name: phpstan-analyse
  image: php:8
  commands:
  - vendor/bin/phpstan analyse src --error-format=json --no-progress > phpstan-results.json
  - cat phpstan-results.json
  depends_on:
  - composer-install

- name: discord-phpunit-failure
  image: appleboy/drone-discord
  settings:
    webhook_id:
      from_secret: discord_webhook_id
    webhook_token:
      from_secret: discord_webhook_token
    message: "{{#success build.status}}✅{{else}}❌ **PHPUnit Tests Failed**{{/success}}  Repository `[{{repo.name}}/{{commit.branch}}]` triggered by event `[{{uppercase build.event}}]` for build.\n    - Commit [[{{commit.sha}}]({{commit.link}})]\n    - Author `[{{commit.author}} / {{commit.email}}]`\n    - Message: {{commit.message}}    - Drone build [[#{{build.number}}]({{build.link}})] reported `[{{uppercase build.status}}]` at `[{{datetime build.finished \"2006.01.02 15:04\" \"\"}}]`\n"
    color: "#dc3545"
  when:
    status: [failure]
  depends_on:
  - phpunit-test

- name: discord-phpstan-failure
  image: plugins/webhook
  settings:
    urls:
      from_secret: discord_webhook_url
    content_type: application/json
    template: |
      {
        "content": "❌ **PHPStan Analysis Failed**",
        "embeds": [
          {
            "title": "Build #{{build.number}} - {{repo.name}}",
            "description": "PHPStan static analysis failed for branch '{{build.branch}}'",
            "color": 15158332,
            "fields": [
              {
                "name": "Branch",
                "value": "{{build.branch}}",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "{{build.commit}}",
                "inline": true
              },
              {
                "name": "Failed Step",
                "value": "PHPStan Analysis",
                "inline": true
              }
            ],
            "footer": {
              "text": "Check the build logs for details"
            }
          }
        ]
      }
  when:
    status: [failure]
  depends_on:
  - phpstan-analyse

- name: discord-success
  image: plugins/webhook
  settings:
    urls:
      from_secret: discord_webhook_url
    content_type: application/json
    template: |
      {
        "content": "✅ **Process successful**",
        "embeds": [
          {
            "title": "Build #{{build.number}} - {{repo.name}}",
            "description": "Process for branch '{{build.branch}}' was finished successfully",
            "color": 5763719,
            "fields": [
              {
                "name": "Tag",
                "value": "{{build.branch}}",
                "inline": true
              },
              {
                "name": "Commit",
                "value": "{{build.commit}}",
                "inline": true
              }
            ]
          }
        ]
      }
  when:
    status: [success]
  depends_on:
  - phpunit-test
  - phpstan-analyse
